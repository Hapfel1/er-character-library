name: Process Character Report

on:
  issues:
    types: [opened]

jobs:
  detect-and-process-report:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      issues: write
    
    steps:
      - name: Extract report info
        id: check_report
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue = context.payload.issue;
            const title = issue.title || '';
            const body = issue.body || '';
            
            console.log('Issue title:', title);
            console.log('Issue body length:', body.length);
            
            // Check if this is a report by looking for the expected format
            const isReport = title.startsWith('[Report]') && 
                            body.includes('**Character ID:**') && 
                            body.includes('**Reason for Report:**');
            
            console.log('Is report:', isReport);
            
            if (!isReport) {
              console.log('Not a report, skipping');
              return;
            }
            
            // Extract details
            const charNameMatch = title.match(/\[Report\]\s*(.+)/);
            const charName = charNameMatch ? charNameMatch[1].trim() : 'Unknown';
            
            const charIdMatch = body.match(/\*\*Character ID:\*\*\s*([^\n]+)/);
            const charId = charIdMatch ? charIdMatch[1].trim() : 'unknown';
            
            const reasonMatch = body.match(/\*\*Reason for Report:\*\*\s*```\n([\s\S]*?)\n```/);
            const reason = reasonMatch ? reasonMatch[1].trim() : body;
            
            console.log('Character:', charName, charId);
            
            core.setOutput('is_report', 'true');
            core.setOutput('char_name', charName);
            core.setOutput('char_id', charId);
            core.setOutput('reason', reason);
            core.setOutput('reporter', issue.user.login);

      - name: Add report label
        if: steps.check_report.outputs.is_report == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const labels = context.payload.issue.labels.map(l => l.name);
            if (!labels.includes('report')) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: ['report', 'review-needed']
              });
            }

      - name: Create summary comment
        if: steps.check_report.outputs.is_report == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const charName = '${{ steps.check_report.outputs.char_name }}';
            const charId = '${{ steps.check_report.outputs.char_id }}';
            const reason = '${{ steps.check_report.outputs.reason }}';
            const reporter = '${{ steps.check_report.outputs.reporter }}';
            
            const comment = '## üìã Report Summary\n\n' +
              '**Character:** ' + charName + ' (`' + charId + '`)\n' +
              '**Reporter:** @' + reporter + '\n' +
              '**Status:** üîç Pending Moderator Review\n\n' +
              '### Report Details\n' +
              reason + '\n\n' +
              '---\n' +
              'A moderator will review this report and take appropriate action.';

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });
