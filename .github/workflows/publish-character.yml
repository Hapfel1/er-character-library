name: Manual Character Publishing

# Manual workflow for publishing characters (backup process)
on:
  workflow_dispatch:
    inputs:
      character_id:
        description: 'Character ID (e.g., character_001)'
        required: true
      character_name:
        description: 'Character display name'
        required: true
      issue_number:
        description: 'Associated issue number (optional)'
        required: false

jobs:
  publish:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      issues: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Validate character exists
        run: |
          char_id="${{ inputs.character_id }}"
          
          # Check if character files exist
          if [ ! -f "characters/${char_id}.erc" ]; then
            echo "ERROR: Character file not found: characters/${char_id}.erc"
            exit 1
          fi
          
          if [ ! -f "metadata/${char_id}.json" ]; then
            echo "WARNING: Metadata not found: metadata/${char_id}.json"
          fi
          
          echo "✓ Character files validated"
      
      - name: Update index.json
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const charId = '${{ inputs.character_id }}';
            const charName = '${{ inputs.character_name }}';
            
            const indexPath = 'index.json';
            const index = JSON.parse(fs.readFileSync(indexPath, 'utf8'));
            
            // Check if already in index
            const existing = index.characters.find(c => c.id === charId);
            if (existing) {
              console.log('Character already in index');
              return;
            }
            
            // Add character entry
            const entry = {
              id: charId,
              name: charName,
              published_at: new Date().toISOString(),
              downloads: 0,
              likes: 0
            };
            
            // Try to read metadata for additional info
            try {
              const metadataPath = `metadata/${charId}.json`;
              if (fs.existsSync(metadataPath)) {
                const metadata = JSON.parse(fs.readFileSync(metadataPath, 'utf8'));
                entry.level = metadata.level;
                entry.class = metadata.class;
                entry.ng_plus = metadata.ng_plus;
              }
            } catch (e) {
              console.log('Could not read metadata:', e.message);
            }
            
            index.characters.push(entry);
            index.characters.sort((a, b) => a.id.localeCompare(b.id));
            index.last_updated = new Date().toISOString();
            
            fs.writeFileSync(indexPath, JSON.stringify(index, null, 2) + '\n');
            console.log('Updated index.json');
      
      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add index.json
          
          # Check if there are changes
          if git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          
          git commit -m "Publish character: ${{ inputs.character_id }} - ${{ inputs.character_name }}"
          git push
      
      - name: Comment on issue
        if: ${{ inputs.issue_number }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = parseInt('${{ inputs.issue_number }}');
            if (isNaN(issueNumber)) return;
            
            const comment = `✅ **Published!**

            Character \`${{ inputs.character_id }}\` has been published to the library.

            It's now available for the community to find and download via the Character Browser.`;
                        
                        github.rest.issues.createComment({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        issue_number: issueNumber,
                        body: comment
                        });