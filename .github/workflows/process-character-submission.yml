name: Process Character Submission

on:
  issues:
    types: [labeled]

jobs:
  process-submission:
    if: contains(github.event.issue.labels.*.name, 'approved')
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      issues: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Fetch issue details
        id: issue_details
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue = context.payload.issue;
            console.log('Issue title:', issue.title);
            console.log('Labels:', issue.labels.map(l => l.name));
            
            // Extract character name from title
            const match = issue.title.match(/\[Character Submission\]\s*(.+)/);
            const charName = match ? match[1].trim() : 'unknown';
            
            // Extract metadata from issue body
            const body = issue.body;
            
            // Extract author
            const authorMatch = body.match(/\*\*Author:\*\*\s*([^\n]+)/);
            const author = authorMatch ? authorMatch[1].trim() : 'Unknown';
            
            // Extract description
            const descMatch = body.match(/\*\*Description:\*\*\s*\n([\s\S]*?)(?:\n\n|$)/);
            const description = descMatch ? descMatch[1].trim().split('\n')[0] : '';
            
            // Extract tags
            const tagsMatch = body.match(/\*\*Tags:\*\*\s*([^\n]+)/);
            const tagsStr = tagsMatch ? tagsMatch[1].trim() : '';
            const tags = tagsStr.length > 0 ? tagsStr.split(',').map(t => t.trim()) : [];
            
            core.setOutput('char_name', charName);
            core.setOutput('issue_number', issue.number);
            core.setOutput('author', author);
            core.setOutput('description', description);
            core.setOutput('tags', JSON.stringify(tags));
      
      - name: Get ZIP attachment URL
        id: find_zip
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue = context.payload.issue;
            
            // Look for attachment URL in issue comments
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number
            });
            
            let downloadUrl = null;
            
            // Search comments for attachment
            for (const comment of comments.data) {
              // GitHub puts attachment URLs like: https://github.com/user/repo/files/...
              const urlMatch = comment.body.match(/https:\/\/github\.com\/[^)\s]+\.zip(?:\?[^)\s]+)?/);
              if (urlMatch) {
                downloadUrl = urlMatch[0];
                break;
              }
            }
            
            // Also check issue body for attachment
            if (!downloadUrl) {
              const bodyMatch = issue.body.match(/https:\/\/github\.com\/[^)\s]+\.zip(?:\?[^)\s]+)?/);
              if (bodyMatch) {
                downloadUrl = bodyMatch[0];
              }
            }
            
            if (!downloadUrl) {
              core.setOutput('zip_found', 'false');
              return;
            }
            
            core.setOutput('zip_found', 'true');
            core.setOutput('zip_url', downloadUrl);
            console.log('Found ZIP attachment:', downloadUrl);
      
      - name: Decline if no ZIP
        if: steps.find_zip.outputs.zip_found != 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = context.issue.number;
            const comment = '❌ **Submission Declined**\n\n' +
              'No ZIP attachment was found in the issue or comments.\n\n' +
              'Please attach your character package ZIP and re-open or re-submit.';
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: comment
            });
            
            try {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                labels: ['needs-attention']
              });
            } catch (e) {
              console.log('Could not add needs-attention label:', e.message);
            }
            
            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                name: 'approved'
              });
            } catch (e) {
              console.log('Could not remove approved label:', e.message);
            }
            
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              state: 'closed'
            });

      - name: Stop if no ZIP
        if: steps.find_zip.outputs.zip_found != 'true'
        run: |
          echo "No ZIP found; stopping workflow."
          exit 1
      
      - name: Download and extract ZIP
        id: extract
        if: steps.find_zip.outputs.zip_found == 'true'
        run: |
          # Download the ZIP
          curl -L "${{ steps.find_zip.outputs.zip_url }}" -o character.zip
          
          # Create extraction directory
          mkdir -p character_package
          cd character_package
          
          # Extract ZIP (overwrite if re-run)
          unzip -oq ../character.zip
          
          # List extracted files
          echo "Extracted files:"
          find . -type f
          
          # Find the .erc file
          ERC_FILE=$(find . -name "*.erc" -type f | head -1)
          if [ -z "$ERC_FILE" ]; then
            echo "ERROR: No .erc file found in ZIP"
            exit 1
          fi
          echo "erc_file=$ERC_FILE" >> $GITHUB_ENV
      
      - name: Generate character ID
        id: gen_id
        run: |
          # Find the highest existing character ID number
          max_id=0
          if [ -d "characters" ]; then
            # Extract numbers from existing character files and find the max
            max_id=$(find characters -name "character_*.erc" -type f | grep -oP 'character_\K[0-9]+' | sort -n | tail -1)
            if [ -z "$max_id" ]; then
              max_id=0
            fi
          fi
          
          next_id=$((max_id + 1))
          char_id=$(printf "character_%03d" $next_id)
          
          echo "character_id=$char_id" >> $GITHUB_OUTPUT
          echo "Generated character ID: $char_id (max was $max_id)"
      
      - name: Validate and move files
        run: |
          char_id="${{ steps.gen_id.outputs.character_id }}"
          
          # Create directories
          mkdir -p characters metadata screenshots/face screenshots/body screenshots/preview thumbnails
          
          # Move .erc file
          ERC_SOURCE=$(find character_package -name "*.erc" -type f | head -1)
          if [ ! -f "$ERC_SOURCE" ]; then
            echo "ERROR: .erc file not found"
            exit 1
          fi
          cp "$ERC_SOURCE" "characters/${char_id}.erc"
          echo "✓ Copied .erc file"
          
          # Move metadata.json if exists
          METADATA_SOURCE=$(find character_package -name "metadata.json" | head -1)
          if [ -f "$METADATA_SOURCE" ]; then
            cp "$METADATA_SOURCE" "metadata/${char_id}.json"
            echo "✓ Copied metadata"
          else
            echo "⚠ No metadata.json found"
          fi
          
          # Move screenshots
          FACE_SOURCE=$(find character_package -name "face.*" | head -1)
          if [ -f "$FACE_SOURCE" ]; then
            cp "$FACE_SOURCE" "screenshots/face/${char_id}$(echo $FACE_SOURCE | sed 's/.*\(\..*\)$/\1/')"
            echo "✓ Copied face screenshot"
          fi
          
          BODY_SOURCE=$(find character_package -name "body.*" | head -1)
          if [ -f "$BODY_SOURCE" ]; then
            cp "$BODY_SOURCE" "screenshots/body/${char_id}$(echo $BODY_SOURCE | sed 's/.*\(\..*\)$/\1/')"
            echo "✓ Copied body screenshot"
          fi
          
          PREVIEW_SOURCE=$(find character_package -name "preview.*" | head -1)
          if [ -f "$PREVIEW_SOURCE" ]; then
            cp "$PREVIEW_SOURCE" "screenshots/preview/${char_id}$(echo $PREVIEW_SOURCE | sed 's/.*\(\..*\)$/\1/')"
            echo "✓ Copied preview screenshot"
          fi
      
      - name: Update metadata.json with author and screenshots
        run: |
          char_id="${{ steps.gen_id.outputs.character_id }}"
          author="${{ steps.issue_details.outputs.author }}"
          submitter="${{ github.event.issue.user.login }}"
          repo_name="${{ github.repository }}"
          
          if [ -f "metadata/${char_id}.json" ]; then
            # Update metadata with author and screenshot URLs
            NODE_CHAR_ID="$char_id" NODE_AUTHOR="$author" NODE_SUBMITTER="$submitter" NODE_REPO="$repo_name" node -e "const fs = require('fs'); const charId = process.env.NODE_CHAR_ID; const author = process.env.NODE_AUTHOR; const submitter = process.env.NODE_SUBMITTER; const baseUrl = 'https://raw.githubusercontent.com/' + process.env.NODE_REPO + '/main'; const metadataPath = 'metadata/' + charId + '.json'; const metadata = JSON.parse(fs.readFileSync(metadataPath, 'utf8')); metadata.author = author; metadata.submitted_by = submitter; metadata.screenshots = { face_url: baseUrl + '/screenshots/face/' + charId + '.jpg', body_url: baseUrl + '/screenshots/body/' + charId + '.jpg', preview_url: baseUrl + '/screenshots/preview/' + charId + '.jpg', thumbnail_url: baseUrl + '/screenshots/thumbs/' + charId + '.jpg' }; fs.writeFileSync(metadataPath, JSON.stringify(metadata, null, 2) + '\n'); console.log('Updated metadata.json with author and screenshot URLs');"
          fi
      
      - name: Update index.json
        id: update_index
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = require('path');
            
            const charId = '${{ steps.gen_id.outputs.character_id }}';
            const charName = '${{ steps.issue_details.outputs.char_name }}';
            const character_author = '${{ steps.issue_details.outputs.author }}';
            const character_description = '${{ steps.issue_details.outputs.description }}';
            const character_tags = JSON.parse('${{ steps.issue_details.outputs.tags }}');
            const github_context = context;
            
            // Read current index.json
            const indexPath = 'index.json';
            let index = JSON.parse(fs.readFileSync(indexPath, 'utf8'));
            
            // Parse metadata to get character details
            const metadataPath = `metadata/${charId}.json`;
            const baseUrl = `https://raw.githubusercontent.com/${context.repo.owner}/${context.repo.repo}/main`;
            
            let characterEntry = {
              id: charId,
              name: charName,
              author: character_author || 'Unknown',
              description: character_description || '',
              tags: character_tags || [],
              erc_url: `characters/${charId}.erc`,
              metadata_url: `${baseUrl}/metadata/${charId}.json`,
              screenshots: {
                face_url: `${baseUrl}/screenshots/face/${charId}.jpg`,
                body_url: `${baseUrl}/screenshots/body/${charId}.jpg`,
                preview_url: `${baseUrl}/screenshots/preview/${charId}.jpg`,
                thumbnail_url: `${baseUrl}/screenshots/thumbs/${charId}.jpg`
              },
              submitted_by: github_context.payload.issue.user.login,
              submitted_at: new Date().toISOString(),
              downloads: 0,
              likes: 0
            };
            
            // Try to read and add metadata details
            if (fs.existsSync(metadataPath)) {
              try {
                const metadata = JSON.parse(fs.readFileSync(metadataPath, 'utf8'));
                characterEntry = {
                  ...characterEntry,
                  level: metadata.level || 0,
                  class: metadata.class || 'Unknown',
                  body_type: metadata.body_type || null,
                  stats: metadata.stats || {},
                  ng_plus: metadata.ng_plus || 0,
                  playtime: metadata.playtime || 'Unknown',
                  playtime_seconds: metadata.playtime_seconds || 0,
                  has_dlc: metadata.has_dlc || false,
                  equipment: metadata.equipment || {},
                  requires_mod: metadata.requires_mod || false,
                  mod_info: metadata.mod_info || null
                };
              } catch (e) {
                console.log('Could not parse metadata:', e.message);
              }
            }
            
            // Add to index
            index.characters.push(characterEntry);
            
            // Sort by ID for consistent ordering
            index.characters.sort((a, b) => a.id.localeCompare(b.id));
            
            // Update metadata
            index.last_updated = new Date().toISOString();
            
            // Write back
            fs.writeFileSync(indexPath, JSON.stringify(index, null, 2) + '\n');
            console.log('Updated index.json with new character');
            core.setOutput('index_updated', 'true');
      
      - name: Create Pull Request
        id: cpr
        uses: peter-evans/create-pull-request@v5
        with:
          commit-message: |
            feat: add character ${{ steps.gen_id.outputs.character_id }} - ${{ steps.issue_details.outputs.char_name }}
            
            Closes #${{ steps.issue_details.outputs.issue_number }}
          title: "[Character] ${{ steps.issue_details.outputs.char_name }} - ${{ steps.gen_id.outputs.character_id }}"
          body: |
            ## Character Submission
            
            **Character:** ${{ steps.issue_details.outputs.char_name }}
            **ID:** ${{ steps.gen_id.outputs.character_id }}
            **Source Issue:** #${{ steps.issue_details.outputs.issue_number }}
            
            ### Changes
            - Added `characters/${{ steps.gen_id.outputs.character_id }}.erc`
            - Added `metadata/${{ steps.gen_id.outputs.character_id }}.json`
            - Added screenshots to `screenshots/`
            - Updated `index.json`
          branch: character-${{ steps.gen_id.outputs.character_id }}
          delete-branch: true
      
      - name: Comment on original issue
        if: steps.cpr.outputs.pull-request-number != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = ${{ steps.issue_details.outputs.issue_number }};
            const prNumber = ${{ steps.cpr.outputs.pull-request-number }};
            const charId = '${{ steps.gen_id.outputs.character_id }}';
            
            const comment = '✅ **Submission Processed!**\n\n' +
              'Your character has been added to the library!\n\n' +
              '**Character ID:** `' + charId + '`\n' +
              '**Pull Request:** #' + prNumber + '\n\n' +
              'The character is now available in the library. Thank you for sharing!';
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: comment
            });
      
      - name: Auto-merge for admins
        if: steps.cpr.outputs.pull-request-number != '' && github.event.issue.user.login == 'Hapfel1'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = ${{ steps.cpr.outputs.pull-request-number }};
            
            try {
              await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                merge_method: 'squash',
                commit_title: 'Add character ${{ steps.gen_id.outputs.character_id }}'
              });
              console.log('PR auto-merged');
            } catch (error) {
              console.log('Could not auto-merge:', error.message);
            }
