name: Validate Character Submission

on:
  issues:
    types: [opened, edited]

jobs:
  validate-submission:
    runs-on: ubuntu-latest
    
    permissions:
      issues: write
      contents: read
    
    steps:
      - name: Determine issue type
        id: issue_type
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const title = context.payload.issue.title;
            const body = context.payload.issue.body || '';
            
            const isSubmission = title.includes('[Character Submission]');
            const isReport = title.startsWith('[Report]') && 
                            body.includes('**Character ID:**') && 
                            body.includes('**Reason for Report:**');
            
            core.setOutput('is_submission', isSubmission ? 'true' : 'false');
            core.setOutput('is_report', isReport ? 'true' : 'false');
            console.log('Submission:', isSubmission, 'Report:', isReport);
      
      - name: Process submission
        if: steps.issue_type.outputs.is_submission == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // Add label
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['character-submission']
            });
            
            // Check for ZIP
            const issue = context.payload.issue;
            let hasZipUrl = false;
            const zipUrlPattern = /https:\/\/github\.com\/[^)\s]+\.zip(?:\?[^)\s]+)?/;
            
            if (zipUrlPattern.test(issue.body)) {
              hasZipUrl = true;
            }
            
            if (!hasZipUrl) {
              const comments = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number
              });
              
              for (const comment of comments.data) {
                if (zipUrlPattern.test(comment.body)) {
                  hasZipUrl = true;
                  break;
                }
              }
            }
            
            if (!hasZipUrl) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: '❌ **Submission Closed - Missing ZIP**\n\nNo ZIP file attachment found. Please attach your character package and reopen.'
              });
              
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                state: 'closed'
              });
              return;
            }
            
            // Check format
            const body = issue.body;
            const errors = [];
            
            if (!body.includes('**Character Name')) errors.push('Missing Character Name');
            if (!body.includes('**Author')) errors.push('Missing Author');
            if (!body.includes('**Tags')) errors.push('Missing Tags');
            
            if (errors.length > 0) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: '⚠️ **Issues Found**\n- ' + errors.join('\n- ')
              });
              
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: ['needs-attention']
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: '✅ **Submission Valid**\n\nYour character submission looks good!\n\nA maintainer will review it shortly and merge it if everything checks out.'
              });
              
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: ['validated']
              });
            }
