name: Validate Character Submission

on:
  issues:
    types: [opened, edited]

jobs:
  validate:
    runs-on: ubuntu-latest
    permissions:
      issues: write
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Ensure label for submissions
        id: label_check
        uses: actions/github-script@v7
        with:
          script: |
            const labels = (context.payload.issue.labels || []).map(l => l.name);
            const hasLabel = labels.includes('character-submission');
            if (!hasLabel && context.payload.issue.title.startsWith('[Character Submission]')) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: ['character-submission']
              });
              core.setOutput('has_label', 'true');
              return;
            }
            core.setOutput('has_label', hasLabel ? 'true' : 'false');

      - name: Skip non-submission issues
        if: steps.label_check.outputs.has_label != 'true'
        run: |
          echo "No submission label found. Skipping validation." >> $GITHUB_STEP_SUMMARY

      - name: Download submission ZIP
        if: steps.label_check.outputs.has_label == 'true'
        id: download
        run: |
          # Extract ZIP URL from issue body
          ZIP_URL=$(echo "${{ github.event.issue.body }}" | grep -oP 'https://github\.com/.+?\.zip' | head -1)
          
          if [ -z "$ZIP_URL" ]; then
            echo "❌ No ZIP file found in issue" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
          wget "$ZIP_URL" -O submission.zip
          unzip submission.zip -d submission/
          
      - name: Validate files
        if: steps.label_check.outputs.has_label == 'true'
        run: |
          # Check required files exist
          if [ ! -f submission/*.erc ]; then
            echo "❌ Missing .erc file" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
          if [ ! -f submission/metadata.json ]; then
            echo "❌ Missing metadata.json" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
          # Check file sizes
          ERC_SIZE=$(stat -f%z submission/*.erc 2>/dev/null || stat -c%s submission/*.erc)
          if [ "$ERC_SIZE" -gt 5000000 ]; then
            echo "❌ .erc file too large (max 5MB)" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
          echo "✅ All validation checks passed" >> $GITHUB_STEP_SUMMARY
          
      - name: Comment on issue
        if: steps.label_check.outputs.has_label == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '✅ **Validation passed!** This character submission is ready for review.\n\nA maintainer will review and merge it soon.'
            })